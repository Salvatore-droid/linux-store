{% extends "base.html" %}

{% block content %}
<div class="animate-fade-in">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8">
        <!-- Header with icon and app name -->
        <div class="flex flex-col items-center mb-8 text-center">
            <div class="p-4 rounded-full bg-indigo-100 text-indigo-600 mb-4">
                <i class="fas fa-download text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-1">Installing Application</h2>
            <p class="text-gray-500" id="app-name">Preparing installation...</p>
        </div>
        
        <!-- Progress container -->
        <div id="progress-container" class="space-y-6">
            <!-- Animated progress bar -->
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700">Installation Progress</span>
                    <span class="text-sm font-medium text-indigo-600" id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-indigo-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Status messages with icons -->
            <div class="space-y-4" id="status-messages">
                <div class="flex items-start p-4 bg-blue-50 rounded-lg">
                    <div class="mr-3 mt-0.5 text-blue-500">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <p class="text-sm text-gray-700" id="progress-message">Starting installation process...</p>
                </div>
            </div>
            
            <!-- Step indicators -->
            <div class="grid grid-cols-3 gap-2 text-center text-xs" id="progress-steps">
                <div class="py-2 px-1 rounded bg-indigo-100 text-indigo-700 font-medium">1. Preparing</div>
                <div class="py-2 px-1 rounded bg-gray-100 text-gray-500">2. Downloading</div>
                <div class="py-2 px-1 rounded bg-gray-100 text-gray-500">3. Installing</div>
            </div>
        </div>
        
        <!-- Success state (hidden initially) -->
        <div id="success-message" class="hidden mt-8 text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Installation Complete!</h3>
            <p class="text-gray-600 mb-6">The application was successfully installed on your system.</p>
            <div class="flex justify-center space-x-4">
                <a href="{% url 'home' %}" 
                   class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300">
                    Return Home
                </a>
                <button id="launch-btn" class="px-6 py-2 border border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors duration-300">
                    Launch Application
                </button>
            </div>
        </div>
        
        <!-- Error state (hidden initially) -->
        <div id="error-message" class="hidden mt-8 text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Installation Failed</h3>
            <p class="text-gray-600 mb-4" id="error-text">An error occurred during installation.</p>
            <div class="flex justify-center">
                <a href="{% url 'home' %}" 
                   class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300">
                    Return Home
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const installId = "{{ install_id }}";
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressMessage = document.getElementById('progress-message');
        const statusMessages = document.getElementById('status-messages');
        const progressSteps = document.getElementById('progress-steps').children;
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const launchBtn = document.getElementById('launch-btn');
        const appNameEl = document.getElementById('app-name');
        const etaEl = document.createElement('span'); // For ETA display
        
        // Add ETA element to the progress container
        progressPercent.parentNode.appendChild(document.createTextNode(' '));
        etaEl.className = 'text-sm font-medium text-gray-500';
        progressPercent.parentNode.appendChild(etaEl);
        
        let appId = '';
        let lastMessage = '';
        let lastProgress = 0;
        let animationStartTime = 0;
        
        // Smooth animation for progress bar
        function animateProgress(targetProgress) {
            const duration = 500; // ms
            const startProgress = lastProgress;
            const change = targetProgress - startProgress;
            const startTime = performance.now();
            
            function updateProgress(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = startProgress + (change * progress);
                
                progressBar.style.width = `${currentValue}%`;
                progressPercent.textContent = `${Math.round(currentValue)}%`;
                
                if (progress < 1) {
                    requestAnimationFrame(updateProgress);
                } else {
                    lastProgress = targetProgress;
                }
            }
            
            requestAnimationFrame(updateProgress);
        }
        
        function createStatusMessage(icon, color, message) {
            if (message === lastMessage) return;
            lastMessage = message;
            
            const messageEl = document.createElement('div');
            messageEl.className = `flex items-start p-4 bg-${color}-50 rounded-lg animate-fade-in`;
            messageEl.innerHTML = `
                <div class="mr-3 mt-0.5 text-${color}-500">
                    <i class="fas fa-${icon}"></i>
                </div>
                <p class="text-sm text-gray-700">${message}</p>
            `;
            
            // Add to container and limit to 3 messages
            statusMessages.prepend(messageEl);
            if (statusMessages.children.length > 3) {
                statusMessages.removeChild(statusMessages.lastChild);
            }
        }
        
        function updateProgressSteps(step) {
            for (let i = 0; i < progressSteps.length; i++) {
                progressSteps[i].className = 'py-2 px-1 rounded bg-gray-100 text-gray-500';
            }
            
            if (step > 0) {
                for (let i = 0; i < step; i++) {
                    progressSteps[i].className = 'py-2 px-1 rounded bg-indigo-100 text-indigo-700 font-medium';
                }
            }
        }
        
        function checkProgress() {
            fetch(`/get_installation_progress/${installId}/`)
                .then(response => response.json())
                .then(data => {
                    appId = data.app_id;
                    
                    // Only animate if progress increased
                    if (data.progress > lastProgress) {
                        animateProgress(data.progress);
                    }
                    
                    // Update ETA if available
                    if (data.eta) {
                        etaEl.textContent = data.eta;
                    }
                    
                    // Update app name
                    if (appId && !appNameEl.textContent.includes(appId)) {
                        const prettyName = appId.split('.').pop().replace(/([A-Z])/g, ' $1').trim();
                        appNameEl.textContent = prettyName || appId;
                    }
                    
                    // Update status messages
                    if (data.message && data.message !== progressMessage.textContent) {
                        progressMessage.textContent = data.message;
                        
                        let icon = 'info-circle';
                        let color = 'blue';
                        
                        if (data.status === 'failed') {
                            icon = 'exclamation-triangle';
                            color = 'red';
                        } else if (data.progress > 90) {
                            icon = 'check-circle';
                            color = 'green';
                        }
                        
                        createStatusMessage(icon, color, data.message);
                    }
                    
                    // Update steps based on progress
                    if (data.progress < 30) {
                        updateProgressSteps(1);
                    } else if (data.progress < 70) {
                        updateProgressSteps(2);
                    } else {
                        updateProgressSteps(3);
                    }
                    
                    // Handle completion
                    if (data.status === 'completed') {
                        successMessage.classList.remove('hidden');
                        launchBtn.addEventListener('click', function() {
                            window.location.href = `/launch_app/${appId}/`;
                        });
                        clearInterval(progressInterval);
                    } else if (data.status === 'failed') {
                        errorText.textContent = data.message.length > 100 ? 
                            "There was an error during installation. Please try again." : 
                            data.message;
                        errorMessage.classList.remove('hidden');
                        clearInterval(progressInterval);
                    }
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                    createStatusMessage('exclamation-triangle', 'red', 'Connection error - trying to reconnect...');
                });
        }
        
        // Start with immediate feedback
        createStatusMessage('spinner', 'blue', 'Starting installation process...');
        updateProgressSteps(1);
        
        // Check more frequently at first, then slow down
        const progressInterval = setInterval(checkProgress, 800);
        checkProgress();
    });
    </script>
<style>
.animate-fade-in {
    animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
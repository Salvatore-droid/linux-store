{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 flex items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden transition-all duration-500 transform hover:shadow-2xl">
        <!-- Installation Header -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 text-white">
            <div class="flex items-center space-x-4">
                <div class="p-3 bg-white bg-opacity-20 rounded-full backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Application Installation</h1>
                    <p class="text-indigo-100 opacity-90" id="app-name">Initializing installation...</p>
                </div>
            </div>
        </div>

        <!-- Progress Container -->
        <div class="p-6 space-y-6" id="progress-container">
            <!-- Animated Progress Bar -->
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">Installation Progress</span>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-semibold text-indigo-600" id="progress-percent">0%</span>
                        <span class="text-xs text-gray-500" id="progress-eta">calculating...</span>
                    </div>
                </div>
                <div class="relative h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-indigo-400 to-purple-500 rounded-full transition-all duration-300 ease-out" style="width: 0%">
                        <div class="absolute inset-0 bg-white opacity-20 animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Download Info (real-time) -->
            <div id="download-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                <div class="flex items-center justify-between text-blue-700">
                    <span class="font-medium">Downloading:</span>
                    <span id="download-size" class="font-mono">0 MB / 0 MB</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-1.5 mt-2">
                    <div id="download-progress-bar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Installation Stages -->
            <div class="grid grid-cols-4 gap-2 text-center text-xs font-medium">
                <div class="stage py-2 px-1 rounded-lg border border-indigo-100 bg-indigo-50 text-indigo-700" data-stage="1">
                    <div class="stage-icon mb-1 text-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    Preparing
                </div>
                <div class="stage py-2 px-1 rounded-lg border border-gray-200 bg-gray-50 text-gray-500" data-stage="2">
                    <div class="stage-icon mb-1 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                    </div>
                    Downloading
                </div>
                <div class="stage py-2 px-1 rounded-lg border border-gray-200 bg-gray-50 text-gray-500" data-stage="3">
                    <div class="stage-icon mb-1 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
                        </svg>
                    </div>
                    Installing
                </div>
                <div class="stage py-2 px-1 rounded-lg border border-gray-200 bg-gray-50 text-gray-500" data-stage="4">
                    <div class="stage-icon mb-1 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    Finalizing
                </div>
            </div>

            <!-- Real-time Logs -->
            <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                <div class="px-4 py-3 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                    <span class="text-xs font-semibold text-gray-600">INSTALLATION LOGS</span>
                    <button id="toggle-logs" class="text-xs text-indigo-600 hover:text-indigo-800 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                <div id="log-container" class="h-48 overflow-y-auto p-3 space-y-1 text-xs font-mono bg-white">
                    <div class="text-gray-400">Starting installation process...</div>
                </div>
            </div>
        </div>

        <!-- Success State (keep as is) -->
        <div id="success-state" class="hidden p-8 text-center bg-green-50 bg-opacity-50">
            <!-- ... success state content ... -->
        </div>

        <!-- Error State (keep as is) -->
        <div id="error-state" class="hidden p-8 text-center bg-red-50 bg-opacity-50">
            <!-- ... error state content ... -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const installId = "{{ install_id }}";
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const progressEta = document.getElementById('progress-eta');
    const downloadInfo = document.getElementById('download-info');
    const downloadSize = document.getElementById('download-size');
    const downloadProgressBar = document.getElementById('download-progress-bar');
    const appNameEl = document.getElementById('app-name');
    const logContainer = document.getElementById('log-container');
    const successState = document.getElementById('success-state');
    const errorState = document.getElementById('error-state');
    const errorMessageEl = document.getElementById('error-message');
    const launchBtn = document.getElementById('launch-btn');
    const retryBtn = document.getElementById('retry-btn');
    const toggleLogsBtn = document.getElementById('toggle-logs');
    const stageElements = document.querySelectorAll('.stage');
    
    let appId = '';
    let lastProgress = 0;
    let logsExpanded = true;
    let lastLogCount = 0;
    
    // Smooth progress animation
    function animateProgress(targetProgress) {
        const duration = 300; // ms
        const startProgress = lastProgress;
        const change = targetProgress - startProgress;
        const startTime = performance.now();
        
        function updateProgress(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function
            const easedProgress = 1 - Math.pow(1 - progress, 3);
            const currentValue = startProgress + (change * easedProgress);
            
            progressBar.style.width = `${currentValue}%`;
            progressPercent.textContent = `${Math.round(currentValue)}%`;
            
            if (progress < 1) {
                requestAnimationFrame(updateProgress);
            } else {
                lastProgress = targetProgress;
            }
        }
        
        requestAnimationFrame(updateProgress);
    }
    
    // Update stages based on progress
    function updateStages(progress) {
        stageElements.forEach(stage => {
            const stageNum = parseInt(stage.dataset.stage);
            
            if (progress >= (stageNum - 1) * 25) {
                if (progress >= stageNum * 25) {
                    // Completed stage
                    stage.classList.remove('bg-gray-50', 'text-gray-500', 'border-gray-200');
                    stage.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-200');
                    stage.querySelector('.stage-icon').classList.remove('text-gray-400');
                    stage.querySelector('.stage-icon').classList.add('text-indigo-500');
                    stage.querySelector('.stage-icon').innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    `;
                } else {
                    // Current stage
                    stage.classList.remove('bg-gray-50', 'text-gray-500', 'border-gray-200');
                    stage.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-300', 'animate-pulse');
                    stage.querySelector('.stage-icon').classList.remove('text-gray-400');
                    stage.querySelector('.stage-icon').classList.add('text-indigo-600');
                    
                    // Reset icon based on stage
                    const icons = [
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />',
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />',
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />',
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />'
                    ];
                    stage.querySelector('.stage-icon').innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            ${icons[stageNum - 1]}
                        </svg>
                    `;
                }
            }
        });
    }
    
    // Add log entry
    function addLogEntry(message, type = 'info') {
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        const logEntry = document.createElement('div');
        
        let icon = '‚Ñπ';
        let color = 'text-blue-600';
        
        if (type === 'success') {
            icon = '‚úì';
            color = 'text-green-600';
        } else if (type === 'warning') {
            icon = '‚ö†';
            color = 'text-yellow-600';
        } else if (type === 'error') {
            icon = '‚úó';
            color = 'text-red-600';
        } else if (message.includes('%')) {
            // Highlight progress messages
            icon = 'üì¶';
            color = 'text-purple-600';
        }
        
        logEntry.innerHTML = `
            <span class="text-gray-400 mr-2">[${timestamp}]</span>
            <span class="${color} font-medium">${icon}</span>
            <span class="${color}">${message}</span>
        `;
        
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Toggle logs
    toggleLogsBtn.addEventListener('click', function() {
        logsExpanded = !logsExpanded;
        if (logsExpanded) {
            logContainer.classList.remove('hidden');
            toggleLogsBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            `;
        } else {
            logContainer.classList.add('hidden');
            toggleLogsBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
            `;
        }
    });
    
    // Check installation progress
    async function checkProgress() {
        try {
            const response = await fetch(`/get_installation_progress/${installId}/`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            appId = data.app_id || appId;
            
            // Update app name
            if (appId && !appNameEl.textContent.includes(appId)) {
                const prettyName = appId.split('.').pop()
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/-/g, ' ')
                    .trim();
                appNameEl.textContent = prettyName || appId;
            }
            
            // Update progress bar
            if (data.progress > lastProgress) {
                animateProgress(data.progress);
            }
            
            // Update ETA
            if (data.eta_seconds) {
                if (data.eta_seconds < 60) {
                    progressEta.textContent = `${data.eta_seconds}s remaining`;
                } else {
                    const minutes = Math.floor(data.eta_seconds / 60);
                    const seconds = data.eta_seconds % 60;
                    progressEta.textContent = `${minutes}m ${seconds}s remaining`;
                }
            }
            
            // Update download info
            if (data.total_download_size && data.downloaded_size) {
                downloadInfo.classList.remove('hidden');
                downloadSize.textContent = `${data.downloaded_size} / ${data.total_download_size}`;
                
                // Calculate download percentage
                const downloadPercent = data.download_progress || 0;
                downloadProgressBar.style.width = `${downloadPercent}%`;
            }
            
            // Update stages
            updateStages(data.progress);
            
            // Add new logs
            if (data.logs && data.logs.length > lastLogCount) {
                const newLogs = data.logs.slice(lastLogCount);
                newLogs.forEach(log => {
                    let type = 'info';
                    if (log.toLowerCase().includes('error') || log.toLowerCase().includes('fail')) {
                        type = 'error';
                    } else if (log.toLowerCase().includes('warning')) {
                        type = 'warning';
                    } else if (log.toLowerCase().includes('complete') || log.toLowerCase().includes('success')) {
                        type = 'success';
                    } else if (log.includes('%')) {
                        type = 'progress';
                    }
                    addLogEntry(log, type);
                });
                lastLogCount = data.logs.length;
            }
            
            // Handle completion states
            if (data.status === 'completed') {
                addLogEntry('‚úÖ Installation completed successfully!', 'success');
                successState.classList.remove('hidden');
                document.getElementById('progress-container').classList.add('hidden');
                
                launchBtn.addEventListener('click', function() {
                    window.location.href = `/launch_app/${appId}/`;
                });
                
                clearInterval(progressInterval);
            } else if (data.status === 'failed') {
                addLogEntry(`‚ùå Installation failed: ${data.message}`, 'error');
                errorMessageEl.textContent = data.message;
                errorState.classList.remove('hidden');
                document.getElementById('progress-container').classList.add('hidden');
                
                retryBtn.addEventListener('click', function() {
                    window.location.reload();
                });
                
                clearInterval(progressInterval);
            }
        } catch (error) {
            console.error('Error fetching progress:', error);
        }
    }
    
    // Initial setup
    addLogEntry('Starting installation process...');
    updateStages(0);
    
    // Start checking progress
    const progressInterval = setInterval(checkProgress, 500); // Check every 500ms for smoother updates
    checkProgress();
});
</script>


<style>
@keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 0.3; }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.animate-bounce {
    animation: bounce 1.5s ease-in-out infinite;
}

/* Smooth scroll for logs */
#log-container {
    scroll-behavior: smooth;
}

/* Custom scrollbar for logs */
#log-container::-webkit-scrollbar {
    width: 6px;
}

#log-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#log-container::-webkit-scrollbar-thumb {
    background: #c7d2fe;
    border-radius: 3px;
}

#log-container::-webkit-scrollbar-thumb:hover {
    background: #a5b4fc;
}

/* Transition effects */
#progress-bar, .stage {
    transition: all 0.3s ease-out;
}

/* Responsive adjustments */
@media (max-width: 640px) {
    .stage {
        font-size: 0.7rem;
        padding: 0.25rem 0.1rem;
    }
    
    #progress-container {
        padding: 1rem;
    }
}
</style>
{% endblock %}